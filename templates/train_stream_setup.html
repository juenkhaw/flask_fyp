{% extends "base.html" %}
{% block content %}
<script>
    var reduce_by_step_id = ["#{{form.step_size.id}}", "#{{form.last_step.id}}"]
    var reduce_by_step_default = [10, -1]
    var reduce_on_plateau_id = ["#{{form.patience.id}}", "#{{form.loss_threshold.id}}", "#{{form.min_lr.id}}"]
    var reduce_on_plateau_default = [10, 0.0001, 0]
	
	var resume_disable_key = ['base_lr', 'dataset', 'debug_mode', 'is_debug_mode', 'lr_scheduler', 'modality', 
								'network', 'pretrain_model', 'split_select', 'test_method']
								
	//var remove_after_flag = false;

    function update_form(target_field, req_json) {
        $.ajax({
            url: "/train_stream",
            type: "POST",
            contentType: "application/json",
            data: req_json,
            success: function(response) {
                $(target_field).html(response.html);
            }
        });
    }

    function set_default(fields, defaults) {
        function func(item, index) {
            $(item).val(defaults[index]);
        }
        fields.forEach(func);
    }

    function update_scheduler_settings(opt) {
        if(opt !== 'none') {
            $("#scheduler_option").show();
            if(opt == 'stepLR') {
                $("#reduce_by_step_option").show();
                $("#reduce_on_plateau_option").hide();
                set_default(reduce_on_plateau_id, reduce_on_plateau_default);
            } else {
                $("#reduce_by_step_option").hide();
                set_default(reduce_by_step_id, reduce_by_step_default);
                $("#reduce_on_plateau_option").show();
            }
        } else {
            $("#scheduler_option").hide();
            $("#{{form.lr_reduce_ratio.id}}").val(0.1)
            set_default(reduce_by_step_id, reduce_by_step_default);
            set_default(reduce_on_plateau_id, reduce_on_plateau_default);
        }
    }

    function update_subbatch_settings() {
        if($("#{{form.is_batch_size.id}}").is(":checked")) {
            $("#batch_size_option").hide();
            $("#{{form.sub_batch_size.id}}").val($("#{{form.batch_size.id}}").val());
            $("#{{form.val_batch_size.id}}").val($("#{{form.batch_size.id}}").val());
        } else {
            $("#batch_size_option").show();
            $("#{{form.sub_batch_size.id}}").val("");
            $("#{{form.val_batch_size.id}}").val("");
        }
    }

    function update_debug_option() {
        if($("#{{form.is_debug_mode.id}}").is(":checked")) {
            $("#debug_option").show();
        } else {
            $("#debug_option").hide();
            $("#{{form.debug_train_size.id}}").val(32);
            $("#{{form.debug_val_size.id}}").val(32);
        }
    }
	
	function update_resume_form() {
		
		var model = $("#{{form.half_model.id}}").val();

		$("form *").prop("disabled", true);
		$.ajax({
			url: "/train_stream",
			type: "POST",
			contentType: "application/json",
			data: JSON.stringify({model: model}),
			success: function(response) {
				if(model === "") {
					$("#pkg_details").html("<span style='color: red;'>No data available</span>");
					$("#{{form.epoch.id}}").html(response.form_epoch);
					for(var key in resume_disable_key) {
						$("#"+resume_disable_key[key]).show().next('b').remove();
					}
					$("form *").prop("disabled", false);
				}
				else {
					$("form *").prop("disabled", false);
					// update package details
					$("#pkg_details").html(response.pkg_html);
					$("#args").hide();
					//update form default selection
					console.log(response.resume_args);
					$("#{{form.epoch.id}}").html(response.form_epoch);
					for(var key in response.resume_args) {
						if(response.resume_args[key] === true || response.resume_args[key] === false) {
							$("#"+key).prop('checked', response.resume_args[key])
						} else {
							$("#"+key).val(response.resume_args[key]);
						}
					}
					update_subbatch_settings();
					update_debug_option();
					update_scheduler_settings(response.resume_args[key]);
										//disbaled those cannot be modified
					for(var key in resume_disable_key) {
						//$("#"+resume_disable_key[key]).prop('readonly', true).prop('style', "background:rgb(220, 220, 220)");
						$("#"+resume_disable_key[key]).hide().next('b').remove();
						$("#"+resume_disable_key[key]).after("<b>"+response.resume_args[resume_disable_key[key]]+"</b>");
					}
					
					//special case
					$("#split_select").val(response.resume_args['split']);
					$("#split_select").hide().next('b').remove();
					$("#split_select").after("<b>"+response.resume_args['split']+"</b>");
				}
			}
		});
	}

    $(document).ready(function() {
        update_scheduler_settings($("#{{form.lr_scheduler.id}}").children("option:selected").val());
        update_subbatch_settings();
        update_debug_option();
        update_form("#{{form.freeze_point.id}}", JSON.stringify({network: $("#{{form.network.id}}").val()}))
		update_resume_form();
		/*update_form("#{{form.output_compare.id}}", 
				JSON.stringify({dataset: $("#{{form.dataset.id}}").val(), 
								split: $("#{{form.split.id}}").val()}));*/

        $("#{{form.dataset.id}}").change(function() {
			if ($("#{{form.half_model.id}}").val() === "") {
				var opt = $(this).children("option:selected").val();
				update_form("#{{form.split.id}}", JSON.stringify({dataset: opt}));
			}
        });

        $("#{{form.batch_size.id}}").change(function() {
            var size = $(this).val();
            update_form("#{{form.sub_batch_size.id}}", JSON.stringify({batchsize: size, field: 'sub'}));
            update_form("#{{form.val_batch_size.id}}", JSON.stringify({batchsize: size, field: 'val'}));
        });

        $("#{{form.is_batch_size.id}}").change(function() {
            update_subbatch_settings();
        })

        $("#{{form.base_lr.id}}").change(function() {
            var lr = $(this).val();
            update_form("#{{form.min_lr.id}}", JSON.stringify({base_lr: lr}));
        });

        $("#{{form.lr_scheduler.id}}").change(function() {
            update_scheduler_settings($(this).children("option:selected").val());
        });

        $("#{{form.is_debug_mode.id}}").change(function() {
            update_debug_option();
        });

        $("#{{form.network.id}}").change(function() {
            update_form("#{{form.freeze_point.id}}", JSON.stringify({network: $(this).val()}))
        });
		
		$("#{{form.half_model.id}}").change(function() {
			update_resume_form();
		});
		
		/*
		$("#{{form.dataset.id}}, #{{form.split.id}}").change(function() {
			update_form("#{{form.output_compare.id}}", 
				JSON.stringify({dataset: $("#{{form.dataset.id}}").val(), 
								split: $("#{{form.split.id}}").val()}));
		});*/
    })
</script>
<style>
    form {
        width: 1050px;
        background-color: lightgray;
        margin: auto;
        text-align: center;
    }
	
	.details {
        height: 150px;
		width: 450px;
        overflow: auto;
		margin: auto;
    }
	
	table {
        border-collapse: collapse;
        border: 1px black solid;
    }
	
	td, th {
        border: 1px black solid;
        padding-right: 5px;
        padding-left: 5px;
        font-size: 14px;
    }

    .decimal {
        display: block;
		width: 80px;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }
	
	fieldset fieldset {
		background: rgb(200,200,200);
	}
	
	form > fieldset:nth-child(odd) {
		background: rgb(220,220,220);
	}
	
	form > fieldset:nth-child(even) {
		background: rgb(180,180,180);
	}
	
	.hint {
		font-size: 14px;
		background: rgb(255, 244, 161);
		display: block;
		padding: 10px;
		width: 80%;
		margin: auto;
	}
	
	.warning {
		font-size: 14px;
		background: rgb(255, 208, 161);
		display: block;
		padding: 10px;
		width: 80%;
		margin: auto;
	}

</style>
<form action="" method="POST" novalidate>
    {{form.hidden_tag()}}
	<fieldset>
		<p class="hint">
			Have a half-trained model ready? <b>Just setup at this section</b> and the rest would be taken care automatically.
		</p>
		<legend>Initialize Trainer</legend>
		<p>
			{{form.half_model.label}}<br>
			{{form.half_model}}
		</p>
		<p>
            <label>Package Overview</label>
            <div id="pkg_details">
            <span style="color: red;">No data available</span>
			</div>
        </p>
	</fieldset>
    <fieldset>
        <legend>Setup</legend>
    <p>
        {{form.modality.label}}<span style="color:red">*</span><br>
        {{form.modality}}
    </p>
    <p>
        {{form.dataset.label}}<span style="color:red">*</span><br>
        {{form.dataset}}<br>
    </p>
    <p>
        {{form.split.label}}<span style="color:red">*</span><br>
        {{form.split}}<br>
    </p>
    <p>
        {{form.network.label}}<span style="color:red">*</span><br>
        {{form.network}}<br>
    </p>
    <p>
        {{form.device.label}}<span style="color:red">*</span><br>
        {{form.device}}<br>
    </p>
    <p>
        {{form.epoch.label}}<span style="color:red">*</span><br>
        {{form.epoch(size=10)}}<br>
        {%for error in form.epoch.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
    </p>
    <fieldset>
        <legend>Pretraining</legend>
        
        <p>
            {{form.pretrain_model.label}}<br>
            {{form.pretrain_model}}<br>
        </p>

        <p>
            {{form.freeze_point.label}}<br>
            {{form.freeze_point}}<br>
        </p>
    </fieldset>

    </fieldset>
    <fieldset>
            <legend>Data Preprocessing</legend>
		<p class="hint">
			Apply data augmentation techinques to improve your network generalizability!
		</p>
        <p>
            {{form.clip_len.label}}<span style="color:red">*</span> (random temporal extraction)<br>
            {{form.clip_len(size=5)}}<br>
            {%for error in form.clip_len.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
        </p>

        <p>
            {{form.is_rand_flip}} {{form.is_rand_flip.label}}
        </p>

        <p>
            Resizing Resolution<span style="color:red">*</span> (before random cropping)<br>
            {{form.resize_h(size=10, placeholder="Height")}}&Tab;
            {{form.resize_w(size=10, placeholder="Width")}}<br>
            {%for error in form.resize_h.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
            {%for error in form.resize_w.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
        </p>

        <p>
            Cropping Resolution<span style="color:red">*</span><br>
            {{form.crop_h(size=10, placeholder="Height")}}&Tab;
            {{form.crop_w(size=10, placeholder="Width")}}<br>
            {%for error in form.crop_h.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
            {%for error in form.crop_w.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
        </p>

        <p>
            {{form.is_mean_sub}} {{form.is_mean_sub.label}}
        </p>
        
    </fieldset>
    <fieldset>
            <legend>Optimizer</legend>

    <p>
        {{form.batch_size.label}}<span style="color:red">*</span><br>
        {{form.batch_size(size=20, placeholder = 'for each params update')}}<br>
        {%for error in form.batch_size.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
    </p>
	<p class="warning">
		Be sure to <b>uncheck</b> the following item <b>IF</b> your device memory could not accomodate a full-size batch at once.
		<b>Specify sub-batch size</b> based on your memory size and each full-size batch shall be partitioned into mini-batch.
	</p>
    <p>
        {{form.is_batch_size}} {{form.is_batch_size.label}}<br>
    </p>

    <fieldset id="batch_size_option">
        <legend>Sub-batch Size</legend>
        <p>
        {{form.sub_batch_size.label}}<span style="color:red">*</span><br>
        {{form.sub_batch_size(size=20, placeholder = 'for each training f/b-prop')}}<br>

        {%for error in form.sub_batch_size.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
        </p>
        <p>
        {{form.val_batch_size.label}}<span style="color:red">*</span><br>
        {{form.val_batch_size(size=20, placeholder = 'for each validation f-prop')}}<br>
    
        {%for error in form.val_batch_size.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
        </p>
    </fieldset>

    <p>
        {{form.base_lr.label}}<span style="color:red">*</span><br>
        {{form.base_lr(size=10)}}<br>
        {%for error in form.base_lr.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
    </p>

    <p>
        {{form.lr_scheduler.label}}<br>
        {{form.lr_scheduler}}<br>
    </p>

    <fieldset id="scheduler_option">
        <legend>LR Scheduler</legend>
        <p>
        {{form.lr_reduce_ratio.label}}<span style="color:red">*</span><br>
        {{form.lr_reduce_ratio(size=10)}}<br>
        {%for error in form.lr_reduce_ratio.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        </p>
        {%endfor%}
        <div id="reduce_by_step_option">
            <p>
            {{form.step_size.label}}<span style="color:red">*</span><br>
            {{form.step_size(size=10)}}<br>
            {%for error in form.step_size.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
            </p>
            <p>
            {{form.last_step.label}}<span style="color:red">*</span><br>
            {{form.last_step(size=10)}}<br>
            {%for error in form.last_step.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
            </p>
        </div>
        <div id="reduce_on_plateau_option">
            <p>
            {{form.patience.label}}<span style="color:red">*</span><br>
            {{form.patience(size=10)}}<br>
            {%for error in form.patience.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
            </p>
            <p>
            {{form.loss_threshold.label}}<span style="color:red">*</span><br>
            {{form.loss_threshold(size=10)}}<br>
            {%for error in form.loss_threshold.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
            </p>
            <p>
            {{form.min_lr.label}}<span style="color:red">*</span><br>
            {{form.min_lr(size=10)}}<br>
            {%for error in form.min_lr.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
            </p>
        </div>
    </fieldset>

    <p>
        {{form.momentum.label}}<span style="color:red">*</span><br>
        {{form.momentum(size=10)}}<br>
        {%for error in form.momentum.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
    </p>

    <p>
        {{form.l2decay.label}}<span style="color:red">*</span><br>
        {{form.l2decay(size=10)}}<br>
        {%for error in form.l2decay.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
    </p>

    <p>
        {{form.dropout.label}}<span style="color:red">*</span><br>
        {{form.dropout(size=10)}}<br>
        {%for error in form.dropout.errors%}
        <span style="color: red;">[{{error}}]</span><br>
        {%endfor%}
    </p>
    
    </fieldset>
    <fieldset>
        <legend>Debugging</legend>
		<p class="hint">
			<b>Enable debugging mode</b> to examine the ability of your network on overfitting small batch of dataset.
			You do not want to see bugs inside your network implementation only after training for few hours.
		</p>
        <p>
            {{form.is_debug_mode}} {{form.is_debug_mode.label}}
        </p>
        <fieldset id="debug_option">
            <legend>Test Run on Small Batch</legend>
        <p>
            {{form.debug_mode.label}}<span style="color:red">*</span><br>
            {{form.debug_mode}}<br>
        </p>
        <p>
            {{form.debug_train_size.label}}<span style="color:red">*</span><br>
            {{form.debug_train_size(size=20)}}<br>
            {%for error in form.debug_train_size.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
        </p>
        <p>
            {{form.debug_val_size.label}}<span style="color:red">*</span><br>
            {{form.debug_val_size(size=20)}}<br>
            {%for error in form.debug_val_size.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
        </p>
        </fieldset>
    </fieldset>
    <fieldset>
        <legend>Output</legend>
        <p>
            {{form.output_name.label}}<br>
            {{form.output_name(size=30, placeholder="Leave it blank if not saving")}}<br>
            {%for error in form.output_name.errors%}
            <span style="color: red;">[{{error}}]</span><br>
            {%endfor%}
        </p>
        <p>
            {{form.output_compare.label}}<br>
            {{form.output_compare}}<br>
        </p>
    </fieldset>
    <p>{{form.submit}}</p>
</form>
{% endblock %}