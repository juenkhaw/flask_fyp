{% extends "base.html" %}
{% block content %}

<script>
	$(document).ready(function() {
		$("#main_loss, #main_acc").html("Updating").show();
		
		$("#main_loss").load("{{url_for('static', filename='graph/main_loss.html')}}")
		$("#main_acc").load("{{url_for('static', filename='graph/main_acc.html')}}")
		
		if({{len(output.keys())}} > 1) {
		
			$(".default_text").hide();
			$("#train_loss, #train_acc, #val_loss, #val_acc").html("Updating");
			$("#train_loss").load("{{url_for('static', filename='graph/compare_train_loss.html')}}")
			$("#train_acc").load("{{url_for('static', filename='graph/compare_train_acc.html')}}")
			$("#val_loss").load("{{url_for('static', filename='graph/compare_val_loss.html')}}")
			$("#val_acc").load("{{url_for('static', filename='graph/compare_val_acc.html')}}")
			
		} else {
			$("#val_sort_model").prop("disabled", true);
		}
		
		update_model_sort("val");
		update_fig("val");
		update_model_sort("test");
		update_fig("test");
		
		$("#val_submit").click(function() {
			update_fig("val");	
		});
		
		$("#test_submit").click(function() {
			update_fig("test");	
		});
		
		$("#val_display").change(function() {
			update_model_sort("val");
		});
		
		$("#test_display").change(function() {
			update_model_sort("test");
		});
		
		$("#cfm_chart").click(function() {
			if(confirm("This might take a while, continue?")) {
				$.ajax({
					url: 'static/inspect/{{base_model}}/cfm.html',
					type: 'HEAD',
					success: function() {
						var open =  window.open('static/inspect/{{base_model}}/cfm.html', '_blank');
						if(open) {
							open.focus();
						}
					}, 
					error: function() {
						alert("Chart is not ready yet.");
					}
				});
			} 
		});
	});
	
	function update_model_sort(mode) {
		if($("#"+mode+"_display").val() === "base") {
			$("#"+mode+"_sort_model").prop("disabled", true);
		}
		else {
			$("#"+mode+"_sort_model").prop("disabled", false);
		}
	}
	
	function update_fig(mode) {
		var display = $("#"+mode+"_display").val();
		var metric = $("#"+mode+"_type").val();
		var sort = $("#"+mode+"_sort").val();
		var sort_model = $("#"+mode+"_sort_model").val();
		
		if(display === "base") {
			$("#"+mode+"_img img").attr("src", "static/inspect/{{base_model}}/"+mode+"/"+metric+"_"+sort+".jpg")
		} else {
			$("#"+mode+"_img img").attr("src", "static/inspect/{{base_model}}/"+mode+"/"+metric+"_"+sort+"_"+sort_model+".jpg")
		}
	}

</script>

<style>
	#outer {
        width: 1050px;
        background-color: lightgray;
        margin: auto;
    }

    .title {
        text-align: center;
        font-weight: bold;
        background: white;
        border: 1px black solid;
        padding: 5px;
    }

    .content {
        padding-left: 10px;
        padding-right: 10px;
        padding-bottom: 10px;
        text-align: center;
    }
	
	#args {
		overflow: auto;
		height: 200px;
	}
	
	table {
        border-collapse: collapse;
        border: 1px black solid;
		margin: auto;
		min-width: 100%;
    }
	
	td, th {
        padding-right: 10px;
		border: 1px black solid;
    }
	
	#acc_table td {
		text-align: center
	}
	
	.graph {
        margin: auto;
        display: inline-block;
    }

    #main_loss, #main_acc {
        width: 480px;
        height: 300px;
    }

    #train_loss, #train_acc, #val_loss, #val_acc {
        width: 250px;
        height: 300px;
    }
	
	.default_text {
        color: red;
        text-align: center;
    }

    #val_img, #test_img {
        margin-left: -10px;
		max-height: 700px;
		overflow: auto;
    }
</style>

<div id="outer">
    <p class="title">Evaluation Result</p>
    <div class="content">
	<p style="color:red; text-align:left">* indicates base model</p>
		<table>
			<thead>
				<th>Top-k Prediction / Model</th>
				{% for model_name in output.keys() %}
					{% for test_method in output[model_name]['test_result'].keys() %}
						{% if output[model_name]['test_result'][test_method] != None %}
							<th>{{model_name}}
							{% if model_name == base_model %}
								<span style='color:red'>*</span>
							{% endif %}
							<br>{{test_method}}</th>
						{% endif %}
					{% endfor %}
				{% endfor %}
			</thead>
			<tbody id="acc_table">
				<tr>
					<td>Averaged Top-1</td>
					{% for model_name in output.keys() %}
						{% for test_method in output[model_name]['test_result'].keys() %}
							{% if output[model_name]['test_result'][test_method] != None %}
								<td>{{output[model_name]['test_result'][test_method]['top-1']}}%</td>
							{% endif %}
						{% endfor %}
					{% endfor %}
				</tr>
				<tr>
					<td>Averaged Top-5</td>
					{% for model_name in output.keys() %}
						{% for test_method in output[model_name]['test_result'].keys() %}
							{% if output[model_name]['test_result'][test_method] != None %}
								<td>{{output[model_name]['test_result'][test_method]['top-5']}}%</td>
							{% endif %}
						{% endfor %}
					{% endfor %}
				</tr>
			</tbody>
		</table>
	</div>
	
	<p class="title">Confusion Matrix</p>
    <div class="content">
		<button id="cfm_chart">View Full Confusion Matrix Chart</button>
		<div id="test_form">
			<label for="test_display">Display</label>&Tab;
            <select id="test_display" name="test_display">
                <option value="base" selected>Base Performance Only</option>
                <option value="diff">Performance Differences with Peers</option>
            </select>
            <label for="test_type">Metric</label>&Tab;
            <select id="test_type" name="test_type">
                <option value="pred" selected>Averaged Accuracy</option>
                <option value="score">Averaged Score</option>
            </select>
            <label for="test_sort">Sort</label>&Tab;
            <select id="test_sort" name="test_sort">
                <option value="none" selected>by performance</option>
                <option value="desc">Best to Worst</option>
                <option value="asc">Worst to Best</option>
            </select>&Tab;
			<select id="test_sort_model" name="test_sort_model">
				<option value="none" selected>by peers difference</option>
				{% for model_name in output.keys() %}
					{% if model_name != base_model %}
						<option testue="{{model_name}}">{{model_name}}</option>
					{% endif %}
                {% endfor %}
            </select>&Tab;
			<button id="test_submit">Update</button>
        </div>
		<div class="graph" id="test_img">
			<img>
        </div>
	</div>
	
	<p class="title">Training State</p>
    <div class="content">
		<div class="graph" id="main_loss">
				
		</div>
		<div class="graph" id="main_acc">

		</div>
		<div id="compare_graph">
			<p class="default_text">No models are selected for comparison</p>
			<div class="graph" id="train_loss">
				
			</div>
			<div class="graph" id="train_acc">

			</div>
			<div class="graph" id="val_loss">
				
			</div>
			<div class="graph" id="val_acc">

			</div>
		</div>
	</div>
	
	<p class="title">Validation Result at last Epoch</p>
    <div class="content">
		<div id="val_form">
			<label for="val_display">Display</label>&Tab;
            <select id="val_display" name="val_display">
                <option value="base" selected>Base Performance Only</option>
                <option value="diff">Performance Differences with Peers</option>
            </select>
            <label for="val_type">Metric</label>&Tab;
            <select id="val_type" name="val_type">
                <option value="pred" selected>Averaged Accuracy</option>
                <option value="score">Averaged Score</option>
            </select>
            <label for="val_sort">Sort</label>&Tab;
            <select id="val_sort" name="val_sort">
                <option value="none" selected>by performance</option>
                <option value="desc">Best to Worst</option>
                <option value="asc">Worst to Best</option>
            </select>&Tab;
			<select id="val_sort_model" name="val_sort_model">
				<option value="none" selected>by peers difference</option>
				{% for model_name in output.keys() %}
					{% if model_name != base_model %}
						<option value="{{model_name}}">{{model_name}}</option>
					{% endif %}
                {% endfor %}
            </select>&Tab;
			<button id="val_submit">Update</button>
        </div>
		<div class="graph" id="val_img">
			<img>
        </div>
	</div>
	
	<p class="title">Experiment Settings</p>
    <div class="content" id="args">
		<table>
			<thead>
				<th>Argument / Model</th>
				{% for model_name in output.keys() %}
					<th>{{model_name}}
					{% if model_name == base_model %}
						<span style='color:red'>*</span>
					{% endif %}
					</th>
				{% endfor %}
			</thead>
			<tbody>
				{% for arg in output[list(output.keys())[0]]['args'].keys() %}
					<tr>
						<td>{{arg}}</td>
					{% for _, pkg in output.items() %}
						<td>{{pkg['args'][arg]}}</td>
					{% endfor %}
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>

{% endblock %}